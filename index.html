<!DOCTYPE html>
<html>
    <head>
        <title>Highcharts in angular</title>
        <script src="jquery-2.2.3.js"></script>
        <script src="angular.js"></script>
        <script src="highcharts.src.js"></script>
        <script>
        
        /**
         * Pageviews chart data model.
         *
         * @author Mikael Forsberg <miforsb@kth.se>
         * @version 20160421T0822
         */
        function pageviewsChartModel()
        {
            /**
             * Date range starting date.
             */
            this.dateRangeFrom = new Date();
            
            /**
             * Date range ending date.
             */
            this.dateRangeTo = new Date();
            
            /**
             * Y-value data sets.
             */
            this.datasets = {};
            
            // "constructor" begins
            
            this.dateRangeFrom.setUTCHours(0);
            this.dateRangeFrom.setUTCMinutes(0);
            this.dateRangeFrom.setUTCSeconds(0);
            this.dateRangeFrom.setUTCMilliseconds(0);
            
            this.dateRangeTo.setUTCHours(0);
            this.dateRangeTo.setUTCMinutes(0);
            this.dateRangeTo.setUTCSeconds(0);
            this.dateRangeTo.setUTCMilliseconds(0);
            
            // default date range is one week ending at today's date
            this.dateRangeFrom.setDate(this.dateRangeFrom.getDate() - 7);
            
            // "constructor" ends
            
            /**
             * Set the date range. The starting date must be an earlier date
             * than the ending date for the range to be considered valid.
             *
             * @param Date from Start of date range
             * @param Date to End of date range
             * @return Boolean True if given a valid range, False otherwise.
             */
            this.setDateRange = function(from, to)
            {
                if (from.getTime() >= to.getTime())
                {
                    return false;
                }
                
                this.dateRangeFrom = from;
                this.dateRangeTo = to;
                
                return true;
            };
            
            /**
             * Add a Y-value dataset. There must be one numeric value in yValues
             * for each distinct date contained in the current date range, and the
             * values must be in chronological order. 
             *
             * @param String name Name of new dataset
             * @param Array yValues Array of numeric Y-values
             * @return void
             */
            this.addDataset = function(name, yValues)
            {
                this.datasets[name] = yValues;
            };
            
            /**
             * Remove a dataset.
             *
             * @param String name Name of dataset to remove
             * @return void
             */
            this.removeDataset = function(name)
            {
                delete this.datasets[name];
            }
            
            /**
             * Retrieve all datasets.
             *
             * @return Object
             */
            this.getDatasets = function()
            {
                return this.datasets;
            };
            
            /**
             * Retrieve the X-axis "values" or "tick labels", i.e. the
             * distinct dates contained in the current date range.
             * 
             * @return Date[]
             */
            this.getXAxisValues = function()
            {
                var values = [];
                
                var at = new Date(this.dateRangeFrom);
                var stop = this.dateRangeTo.getTime();
                
                while (at.getTime() < stop)
                {
                    values.push(new Date(at));
                    at.setDate(at.getDate() + 1);
                }
                
                return values;
            };
        };
        
        var app = angular.module('theApp', []);
        
        app.controller('mainController', ['$scope', 'chartsService', function($scope, chartsService)
        {
            $scope.addChickens = function()
            {
                console.log('hello from addChickens');
                
                chartsService.getChart('test').addDataset('Chicken', [3,4,5,6,7,8,9]);
            };
            
            $scope.delChickens = function()
            {
                console.log('hello from delChickens');
                
                chartsService.getChart('test').removeDataset('Chicken');
            };
        }]);
        
        app.controller('chartController', ['chartsService', function(chartsService)
        {
            console.log('hello from chartcontroller');
            
            var chart = chartsService.createChart('test', new pageviewsChartModel());
            chart.addDataset('Cow', [1,2,3,4,5,6,7]);
        }]);
        
        app.service('chartsService', function()
            {
                this.charts = {};
                
                this.createChart = function(name, model)
                {
                    this.charts[name] = model;
                    return model;
                };
                
                this.getChart = function(name)
                {
                    return this.charts[name];
                };
            });
        
        app.directive('highchart', ['chartsService', function(chartsService)
        {
            console.log('hello from highchart directive');
            
            return {
                restrict: 'E',
                
                link: function(scope, element, attrs)
                {
                    console.log('hello from highchart directive link');
                    
                    function updateChart()
                    {
                        console.log('hello from updateChart');
                        
                        var series = [];
                        var datasets = scope.chartModel.getDatasets();
                        
                        for (var name in datasets)
                        {
                            series.push({animation: false, name: name, data: datasets[name]});
                        }
                        
                        // will running this again and again properly (no leaks) replace the stuff
                        // that existed previously? are there more effecient ways to control
                        // highcharts? ("restarting" is probably the least efficient way!)
                        $(function () { 
                            $(element).highcharts({
                                chart: {
                                    type: 'line',
                                    animation: false
                                },
                                title: {
                                    text: 'Page Views'
                                },
                                xAxis: {
                                    categories: scope.chartModel.getXAxisValues()
                                },
                                yAxis: {
                                    title: {
                                        text: 'Views'
                                    }
                                },
                                series: series
                            });
                        });
                    };
                    
                    scope.chartModel = chartsService.getChart(attrs.chartName);
                    scope.$watch('chartModel', updateChart, true);
                }
            }
        }]);
        
        </script>
    </head>
    <body ng-app="theApp" ng-controller="mainController">
        <input type="button" ng-click="addChickens()" />
        <input type="button" ng-click="delChickens()" />
        <highchart style="display:block;" chart-name="test" ng-controller="chartController" />
    </body>
</html>
